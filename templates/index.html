<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Cloud</title>
    
</head>
<body>

    <h1>Home Cloud</h1>

    <!-- Storage Path Selection -->
    <h3>Set storage path</h3>
    <div>
        <p class="storage-path">Current Storage Path: <span id="storage-path", style="font-style: italic;">{{ storage_path }}</span></p>
        <button onclick="document.getElementById('folder-picker').click()">Change Storage Path</button>
        <input type="file" id="folder-picker" webkitdirectory directory style="display: none;">
    </div>

    <!-- Upload Files Form -->
    <h3>Upload Files</h3>
    <form method="POST" enctype="multipart/form-data">
        {{ upload_form.hidden_tag() }}
        {{ upload_form.file.label }} {{ upload_form.file() }}
        {{ upload_form.submit() }}
    </form>

    <h3>Download all items stored in the Home-Cloud</h3>

    <!-- Download All Button -->
    <form action="{{ url_for('download_all', req_path=current_path) }}" method="get">
        <button type="submit">Download All</button>
    </form>

    <h3>Current Directory: {{ current_path }}</h3>

    {% if current_path %}
        <a href="{{ url_for('home', req_path=parent_path) }}">‚¨ÜÔ∏è Go Back</a>
    {% endif %}

    <div class="grid-container">
        {% for file in files %}
            <div class="grid-item">
                {% set file_ext = file.split('.')[-1].lower() %}
                
                {% if '.' not in file %}
                    <a href="{{ url_for('home', req_path=current_path + '/' + file) }}">
                        <img src="{{ url_for('static', filename='folder-icon.png') }}" alt="Folder" class="folder-icon">
                    </a>
                    <span class="file-name">{{ file }}</span>
                
                {% elif file_ext in ['png', 'jpg', 'jpeg', 'gif'] %}
                    <a href="{{ url_for('home', req_path=current_path + '/' + file) }}" download>
                        <img src="{{ url_for('static', filename='uploads/' + current_path + '/' + file) }}" alt="{{ file }}">
                    </a>
                    <span class="file-name">{{ file }}</span>
                
                {% elif file_ext == 'pdf' %}
                    <a href="{{ url_for('home', req_path=current_path + '/' + file) }}" download>üìÑ {{ file }}</a>
                {% elif file_ext == 'txt' %}
                    <a href="{{ url_for('home', req_path=current_path + '/' + file) }}" download>üìù {{ file }}</a>
                {% else %}
                    <a href="{{ url_for('home', req_path=current_path + '/' + file) }}" download>üìÅ {{ file }}</a>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <script>
        document.getElementById('folder-picker').addEventListener('change', function(event) {
            if (event.target.files.length > 0) {
                let folderPath = event.target.files[0].webkitRelativePath.split("/")[0];  // Get folder name
                let absolutePath = event.target.files[0].path.replace("\\" + folderPath, "");  // Get absolute path
                
                fetch('/set-storage-path', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ new_path: absolutePath })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById("storage-path").textContent = data.new_path;
                        alert("Storage path updated successfully!");
                        location.reload();  // Reload to reflect changes
                    } else {
                        alert("Error: " + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    </script>

</body>
</html>
